<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>[talk, dm]</title>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <!-- socket.io CDN -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .container {
            background-color: #9bbbd4;
            height: 500px;
            margin-top: 20px;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* [HEADER] */
        .container header {
            width: 100%;
            box-shadow: 0px 2px 2px #7a7a7a20;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-basis: 10%;
        }

        /* [SECTION] */
        .container section {
            padding: 16px;
            overflow-y: auto;
            flex-basis: 80%;
        }

        /* Ïä§ÌÅ¨Î°§ Î™®Ïñë Î≥ÄÍ≤Ω */
        .container section::-webkit-scrollbar {
            width: 4px;
        }

        .container section::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 10px;
            padding: 1px;
            margin: 1px;
        }

        .container section::-webkit-scrollbar-track {
            padding: 1px;
            background-color: #ccc;
            border-radius: 10px;
            box-shadow: inset 0px 0px 2px white;
        }

        /* section-ÎßêÌíçÏÑ† */
        /* 
      <div class="speech me">
          <span class="msg-box">ÎÇ¥ Î©îÏÑ∏ÏßÄ</span>
        </div>
        <div class="speech other">
          <span>socket.id</span>
          <span>Îã§Î•∏ ÏÇ¨ÎûåÏù¥ Î≥¥ÎÇ∏ Ï±ÑÌåÖ ÎÇ¥Ïö©</span>
        </div>
      */

        .container .speech .msg-box {
            display: inline-block;
            box-shadow: 1px 1px 5px #7a7a7a;
            border-radius: 8px;
            padding: 0.3rem;
            margin: 0.5rem 0;
            max-width: 60%;
        }

        .container .speech.me {
            text-align: right;
        }

        .container .speech.other {
            position: relative;
            margin: 10px 0;
        }

        /* dm css */
        .container .speech.other.dm .msg-box {
            background-color: #fff5;

        }

        .container .speech.other .nickname {
            font-size: 12px;
            position: absolute;
            top: -12px;
        }

        .container .speech.me .msg-box {
            background-color: #fef01b;
        }

        .container .speech.other .msg-box {
            background-color: #ffffff;
        }

        /* [MSG_FORM] */
        .container .msg-form {
            display: flex;
            justify-content: space-between;
            padding: 8px 16px;
            flex-basis: 10%;
        }

        .container .msg-form input {
            flex-basis: 75%;
            border: none;
            outline: none;
            border-radius: 100px;
            padding: 8px 16px;
        }

        .container .msg-form input:focus+button {
            background-color: #fef01b;
        }

        .container .msg-form button {
            flex-basis: 12%;
            border: none;
            border-radius: 5px;
        }

        /* dm-select */
        .container .msg-form select {
            flex-basis: 12%;
            border: none;
            border-radius: 5px;
            outline: none;
            text-align: center;
        }

        /* ÏûÖÏû•ÏïåÎ¶º CSS */
        .container section .notice {
            width: 80%;
            background-color: #fff5;
            border-radius: 50px;
            text-align: center;
            padding: 2px;
            color: #4449;
            margin: 8px auto;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <!-- ÎãâÎÑ§ÏûÑ ÏûÖÎ†•, Ï±ÑÌåÖÏ∞Ω Î≤ÑÌäº Ï∂îÍ∞Ä -->
    <div class="entry-box">
        <input type="text" placeholder="ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî." id="nickname" />
        <button onclick="join()">Ï±ÑÌåÖÎ∞© ÏûÖÏû•ÌïòÍ∏∞</button>
    </div>
    <div class="container d-none">
        <header>ÏΩîÏΩîÏïÑÌÜ°üêõ</header>
        <section></section>
        <form class="msg-form" id="msg_form">
            <select id="dm_select"></select>
            <input type="text" placeholder="Î©îÏÑ∏ÏßÄ ÏûÖÎ†•" />
            <button>Ï†ÑÏÜ°</button>
        </form>
    </div>
    <script>
        const socket = io();
        const chatCntr = document.querySelector('.container section');
        const chatForm = document.getElementById('msg_form');
        const container = document.querySelector('.container');
        let myNick;

        socket.on('notice', (noticeMsg) => {
            const div = document.createElement("div");
            div.textContent = noticeMsg;
            div.classList.add('notice');
            chatCntr.appendChild(div);
        })

        // Ïã§Ïäµ 4 - Ï±ÑÌåÖ Ï£ºÍ≥† Î∞õÍ∏∞
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = chatForm.querySelector('input');
            if (!input.value.trim()) return;

            // [4-1] ÌèºÏù¥ Ï†úÏ∂ú ÎêòÏóàÏùÑ Îïå Î©îÏãúÏßÄÎ•º ÏÑúÎ≤ÑÎ°ú Ï†ÑÎã¨
            // Î≥ÄÍ≤Ω => selectÏùò valueÍ∞Ä Ìè¨Ìï®Îêú Îç∞Ïù¥ÌÑ∞
            const sendData = {
                myNick,
                dm: select.value,
                msg: input.value
            }
            // socket.emit('send', input.value);
            socket.emit('send', sendData);
            input.value = '';
        })
        // [4-3] Î™®Îì† Î©îÏãúÏßÄÎ•º Ï†ÑÎã¨Î∞õÍ≥† ÎÇòÏôÄ Îã§Î•∏ ÏÇ¨ÎûåÏùò Î©îÏãúÏßÄÎ•º Íµ¨Î∂Ñ
        socket.on('message', (msgInfo) => {
            const div = document.createElement("div");
            const span = document.createElement('span'); // ÎÇ¥Ïö©
            span.classList.add('msg-box');
            // span.textContent = msgInfo.message; // Î©îÏãúÏßÄ ÏÇΩÏûÖ.
            if (msgInfo.isDm) {
                div.classList.add('dm')
                span.textContent = '[Í∑ìÏÜçÎßê]' + msgInfo.message
            } else {
                span.textContent = msgInfo.message; // Î©îÏãúÏßÄ ÏÇΩÏûÖ.
            }

            if (myNick === msgInfo.id) {
                div.classList.add('speech', 'me');
            } else {
                const nickname = document.createElement('span'); // ÎãâÎÑ§ÏûÑ
                nickname.textContent = msgInfo.id
                nickname.classList.add('nickname');
                div.classList.add('speech', 'other');
                div.prepend(nickname);
            }
            div.append(span);
            chatCntr.appendChild(div);

            // sectionÏù¥ Í∏∏Ïñ¥ÏßÄÎ©¥ Ïä§ÌÅ¨Î°§ Îß® Î∞ëÏúºÎ°ú
            chatCntr.scrollTop = chatCntr.scrollHeight;
        })

        // ÎãâÎÑ§ÏûÑ ÏÇ¨Ïö©Ìï¥ÏÑú Ï±ÑÌåÖÎ∞© ÏûÖÏû•ÌïòÍ∏∞
        const nicknameInput = document.getElementById('nickname')
        // ÎãâÎÑ§ÏûÑ ÏÇ¨Ïö© 1. ÏÑúÎ≤ÑÎ°ú ÏöîÏ≤≠ ÎãâÎÑ§ÏûÑÏùÑ Î≥¥ÎÇ¥ Ï§ëÎ≥µÏ≤¥ÌÅ¨
        const join = () => {
            socket.emit('checkNick', nicknameInput.value)
        }
        // ÎãâÎÑ§ÏûÑ ÏÇ¨Ïö© 3.
        // 1) ÎãâÎÑ§ÏûÑ Ï§ëÎ≥µÏúºÎ°ú ÏûÖÏû• Ïã§Ìå®
        socket.on('error', (errMsg) => {
            alert(errMsg);
        });
        // 2) ÏûÖÏû• ÏÑ±Í≥µ, ÎÇ¥ ÎãâÎÑ§ÏûÑ Ï†ïÎ≥¥ Ï†ÄÏû•, Ï±ÑÌåÖÏ∞Ω ÌôúÏÑ±Ìôî Î∞è ÎãâÎÑ§ÏûÑ ÏûëÏÑ±ÎûÄ ÎπÑÌôúÏÑ±Ìôî
        socket.on('entrySuccess', (nickname) => {
            myNick = nickname;
            nickname.disabled = true;
            document.querySelector('.entry-box').classList.add('d-none');
            container.classList.remove('d-none');
        })

        // 3) select ÏïàÏùò optionÏùÑ ÎãâÎÑ§ÏûÑ Ï†ïÎ≥¥Î°ú Ï±ÑÏö∞Í∏∞.
        const select = document.getElementById('dm_select');
        socket.on("updateNicks", (nickInfo) => {
            let options = `<option value="ALL">Ï†ÑÏ≤¥</option>`;
            for (let key in nickInfo) {
                let option = `<option value="${key}">${nickInfo[key]}</option>`
                if (nickInfo[key] !== myNick) options += option;
            }
            select.innerHTML = options
        })
    </script>
</body>

</html>